import <%= userModel %> from "../model/<%= userModel %>.<%= ext %>"
import bcryptjs from 'bcryptjs'
import {tokenGenerator} from '../utils/jwt.<%= ext %>'
import type { Request , Response } from 'express'

const login = async (req : Request , res : Response) => {
    try {
        const {password} = req.body; 
        const identifier = req.body.username || req.body.email || null;
        
        if(!password || !identifier) return res.status(401).json({
            success : false,
            message : "credentials missing !!!"
        });
        const user = await <%= userModel %>.findOne({identifier});
        if(!user){
            return res.status(210).json({
                success : false,
                message : "User not found !!"
            })
        };
        
        const isValid = await bcryptjs.compare(password , user.password);
        if(!isValid) return res.status(403).json({
            success : false,
            message : "Credentials are wrong !!"
        });

        const tokens = tokenGenerator({
            _id : user._id,
            name : user.name || user.username,
            email : user.email
        });

        return res.status(200)
                .cookie("accessToken" , tokens.accessToken , {httpOnly : true , secure : true , sameSite : "strict"})
                .cookie("refreshToken" , tokens.refreshToken , {httpOnly : true , secure : true , sameSite : "strict"})
                .json({
                    success : true,
                    message : "User Logged in successfully !!!"
                })
            } catch (error : any) {
                return res.status(500).json({
                    message : "Interna l server error !!!",
                    error : error.message || error,
                    success : false
                });
            }
        };
        
        const signup = async (req : Request, res : Response) => {
            try {
                const payload = req.body;
                if(!payload){
                    return res.status(401).json({
                        message : "Info is not provided !!!",
                        success : false
                    });
                };
                
                const identifier = payload.username || payload.email;
                const isUserExist = await <%= userModel %>.findOne({identifier});
                if(!isUserExist){
                    return res.status(209).json({
                        message : "Credentials is in use !!!",
                        success : false
                    });
                };
                
                const newUser = await <%= userModel %>.create(payload);
                await newUser.save();
                 
                 const tokens = tokenGenerator({
            _id : newUser._id,
            name : newUser.name || newUser.username,
            email : newUser.email
        });
                return res.status(200)
                        .cookie("accessToken" , tokens.accessToken , {httpOnly : true , secure : true , sameSite : "strict"})
                        .cookie("refreshToken" , tokens.refreshToken , {httpOnly : true , secure : true , sameSite : "strict"})
                        .json({
                            success : true,
                            message : "User registered successfully !!!"
                        })
            } catch (error : any) {
                return res.status(500).json({
                    message : "Internal server error !!!",
                    success : false,
                    error : error.message || error
                })
            }
        }


export {
    login , 
    signup
}