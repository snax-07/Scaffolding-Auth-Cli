import type { Request, Response, NextFunction } from "express";
import { Authnticator } from "../utils/jwt.<%= ext %>";

if (!process.env.JWT_SECRET) {
  throw new Error("JWT_SECRET is not defined");
}
const JWT_SECRET = process.env.JWT_SECRET;


interface AuthRequest extends Request {
  user?: unknown;
}

export default async function AuthMiddleware(
  req: AuthRequest,
  res: Response,
  next: NextFunction
) {
  try {
    const token = extractToken(req) as string | null;

    if(!token){
        return res.status(401).json({
            message : "TOKEN is missing !!!"
        });
    }

    const response = await Authnticator({
      token,
      secret: JWT_SECRET
    });

    if (!response.success) {
      return res.status(403).json({
        message: response.message,
        error: response.error ?? "Unauthorized"
      });
    }

    req.user = response.user;
    next();

  } catch (err) {
    const error = err as Error;
    return res.status(500).json({
      message: "Internal server error",
      error: error.message
    });
  }
}


function extractToken(req: Request): string | null {
  const authHeader = req.headers.authorization;
  if (authHeader && authHeader?.startsWith("Bearer ")) {
    return authHeader.split(" ")[1] as string;
  }

  if (req.cookies?.accessToken) {
    return req.cookies.accessToken as string;
  }

  return null;
}



